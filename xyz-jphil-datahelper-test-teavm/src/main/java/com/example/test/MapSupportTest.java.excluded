package com.example.test;

import org.teavm.jso.JSBody;
import xyz.jphil.datahelper.teavm.TeaVMMapLike;

import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.Map;

public class MapSupportTest {

    public static void main(String[] args) {
        System.out.println("=== Map Support Test ===\n");

        // Test 1: Map<String, String>
        test1_MapStringString();

        // Test 2: Map<String, Integer>
        test2_MapStringInteger();

        // Test 3: Map<Integer, String>
        test3_MapIntegerString();

        // Test 4: Map<String, PersonDTO>
        test4_MapStringDataHelper();

        // Test 5: HashMap vs LinkedHashMap
        test5_MapImplementations();

        // Test 6: Round-trip (toMapLike → fromMapLike)
        test6_RoundTrip();

        System.out.println("\n=== All Map Tests Passed! ===");
    }

    // Test 1: Map<String, String>
    @JSBody(script = "console.log('Test 1: Map<String, String>');")
    private static native void log1();

    public static void test1_MapStringString() {
        log1();

        // Create DTO
        MapTestDTO dto = new MapTestDTO();
        dto.setName("Test");

        // Set Map<String, String>
        Map<String, String> tags = new HashMap<>();
        tags.put("category", "test");
        tags.put("priority", "high");
        dto.setTags(tags);

        // Verify getter
        assert dto.getTags().get("category").equals("test");
        assert dto.getTags().get("priority").equals("high");

        // Serialize to MapLike
        var mapLike = dto.toMapLike(true);

        // Deserialize back
        MapTestDTO dto2 = new MapTestDTO();
        dto2.fromMapLike(mapLike);

        // Verify
        assert dto2.getName().equals("Test");
        assert dto2.getTags() != null;
        assert dto2.getTags().get("category").equals("test");
        assert dto2.getTags().get("priority").equals("high");

        logSuccess("Test 1 passed: Map<String, String>");
    }

    // Test 2: Map<String, Integer>
    @JSBody(script = "console.log('Test 2: Map<String, Integer>');")
    private static native void log2();

    public static void test2_MapStringInteger() {
        log2();

        MapTestDTO dto = new MapTestDTO();

        // Set Map<String, Integer>
        Map<String, Integer> scores = new LinkedHashMap<>();
        scores.put("math", 95);
        scores.put("science", 87);
        scores.put("english", 92);
        dto.setScores(scores);

        // Verify
        assert dto.getScores().get("math") == 95;
        assert dto.getScores().get("science") == 87;

        // Serialize
        var mapLike = dto.toMapLike(true);

        // Deserialize
        MapTestDTO dto2 = new MapTestDTO();
        dto2.fromMapLike(mapLike);

        // Verify
        assert dto2.getScores() != null;
        assert dto2.getScores().get("math") == 95;
        assert dto2.getScores().get("science") == 87;
        assert dto2.getScores().get("english") == 92;

        logSuccess("Test 2 passed: Map<String, Integer>");
    }

    // Test 3: Map<Integer, String>
    @JSBody(script = "console.log('Test 3: Map<Integer, String>');")
    private static native void log3();

    public static void test3_MapIntegerString() {
        log3();

        MapTestDTO dto = new MapTestDTO();

        // Set Map<Integer, String>
        Map<Integer, String> indexedValues = new HashMap<>();
        indexedValues.put(1, "first");
        indexedValues.put(2, "second");
        indexedValues.put(10, "tenth");
        dto.setIndexedValues(indexedValues);

        // Verify
        assert dto.getIndexedValues().get(1).equals("first");
        assert dto.getIndexedValues().get(10).equals("tenth");

        // Serialize
        var mapLike = dto.toMapLike(true);

        // Deserialize
        MapTestDTO dto2 = new MapTestDTO();
        dto2.fromMapLike(mapLike);

        // Verify
        assert dto2.getIndexedValues() != null;
        assert dto2.getIndexedValues().get(1).equals("first");
        assert dto2.getIndexedValues().get(2).equals("second");
        assert dto2.getIndexedValues().get(10).equals("tenth");

        logSuccess("Test 3 passed: Map<Integer, String>");
    }

    // Test 4: Map<String, PersonDTO>
    @JSBody(script = "console.log('Test 4: Map<String, PersonDTO>');")
    private static native void log4();

    public static void test4_MapStringDataHelper() {
        log4();

        MapTestDTO dto = new MapTestDTO();

        // Create nested objects
        PersonDTO person1 = new PersonDTO();
        person1.setFirstName("Alice");
        person1.setAge(30);

        PersonDTO person2 = new PersonDTO();
        person2.setFirstName("Bob");
        person2.setAge(25);

        // Set Map<String, PersonDTO>
        Map<String, PersonDTO> people = new LinkedHashMap<>();
        people.put("person1", person1);
        people.put("person2", person2);
        dto.setPeople(people);

        // Verify
        assert dto.getPeople().get("person1").getFirstName().equals("Alice");
        assert dto.getPeople().get("person2").getAge() == 25;

        // Serialize (deep)
        var mapLike = dto.toMapLike(true);

        // Deserialize
        MapTestDTO dto2 = new MapTestDTO();
        dto2.fromMapLike(mapLike);

        // Verify nested objects
        assert dto2.getPeople() != null;
        assert dto2.getPeople().get("person1").getFirstName().equals("Alice");
        assert dto2.getPeople().get("person1").getAge() == 30;
        assert dto2.getPeople().get("person2").getFirstName().equals("Bob");
        assert dto2.getPeople().get("person2").getAge() == 25;

        logSuccess("Test 4 passed: Map<String, PersonDTO>");
    }

    // Test 5: HashMap vs LinkedHashMap
    @JSBody(script = "console.log('Test 5: HashMap vs LinkedHashMap');")
    private static native void log5();

    public static void test5_MapImplementations() {
        log5();

        MapTestDTO dto = new MapTestDTO();

        // Set HashMap field
        HashMap<String, String> hashMap = new HashMap<>();
        hashMap.put("key1", "value1");
        dto.setHashMapField(hashMap);

        // Set LinkedHashMap field
        LinkedHashMap<String, Integer> linkedHashMap = new LinkedHashMap<>();
        linkedHashMap.put("a", 1);
        linkedHashMap.put("b", 2);
        linkedHashMap.put("c", 3);
        dto.setLinkedHashMapField(linkedHashMap);

        // Verify types
        assert dto.getHashMapField() instanceof HashMap;
        assert dto.getLinkedHashMapField() instanceof LinkedHashMap;

        // Serialize
        var mapLike = dto.toMapLike(true);

        // Deserialize
        MapTestDTO dto2 = new MapTestDTO();
        dto2.fromMapLike(mapLike);

        // Verify values (order preserved in LinkedHashMap)
        assert dto2.getHashMapField().get("key1").equals("value1");
        assert dto2.getLinkedHashMapField().get("a") == 1;
        assert dto2.getLinkedHashMapField().get("c") == 3;

        logSuccess("Test 5 passed: HashMap vs LinkedHashMap");
    }

    // Test 6: Round-trip
    @JSBody(script = "console.log('Test 6: Round-trip');")
    private static native void log6();

    public static void test6_RoundTrip() {
        log6();

        // Create complex DTO
        MapTestDTO dto = new MapTestDTO();
        dto.setName("Round Trip Test");
        dto.setAge(42);

        // Multiple maps
        Map<String, String> tags = new HashMap<>();
        tags.put("env", "production");
        dto.setTags(tags);

        Map<String, Integer> scores = new LinkedHashMap<>();
        scores.put("q1", 100);
        scores.put("q2", 95);
        dto.setScores(scores);

        Map<Integer, String> indexed = new HashMap<>();
        indexed.put(0, "zero");
        indexed.put(100, "hundred");
        dto.setIndexedValues(indexed);

        // Nested DataHelper objects in Map
        PersonDTO person = new PersonDTO();
        person.setFirstName("Charlie");
        person.setAge(35);

        Map<String, PersonDTO> people = new HashMap<>();
        people.put("charlie", person);
        dto.setPeople(people);

        // Round-trip: DTO → MapLike → DTO
        var mapLike = dto.toMapLike(true);
        MapTestDTO dto2 = new MapTestDTO();
        dto2.fromMapLike(mapLike);

        // Verify all fields
        assert dto2.getName().equals("Round Trip Test");
        assert dto2.getAge() == 42;
        assert dto2.getTags().get("env").equals("production");
        assert dto2.getScores().get("q1") == 100;
        assert dto2.getScores().get("q2") == 95;
        assert dto2.getIndexedValues().get(0).equals("zero");
        assert dto2.getIndexedValues().get(100).equals("hundred");
        assert dto2.getPeople().get("charlie").getFirstName().equals("Charlie");
        assert dto2.getPeople().get("charlie").getAge() == 35;

        logSuccess("Test 6 passed: Round-trip");
    }

    @JSBody(params = {"msg"}, script = "console.log('✓ ' + msg);")
    private static native void logSuccess(String msg);
}
